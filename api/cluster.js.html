<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>cluster.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Events</h3><ul><li><a href="global.html#Fsw#event:error">error</a></li></ul><h3>Global</h3><ul><li><a href="global.html#Cluster">Cluster</a></li><li><a href="global.html#Fsw">Fsw</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">cluster.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict' ;

var Fsw = require('./fsw') ;
var Emitter = require('events').EventEmitter ;
var util = require('util') ;
var _ = require('lodash') ;
var assert = require('assert') ;

function fswId(obj) {
  return obj.address + ':' + obj.port + ':' + obj.profile ;
}

/**
 * Cluster of freeswitch servers to proxy requests to
 */
function Cluster() {
  if (!(this instanceof Cluster)) { return new Cluster(); }

  this.pool = {} ;
  this.offset = 0 ;

  Emitter.call(this); 

}
util.inherits(Cluster, Emitter) ;

exports = module.exports = Cluster ;

/**
 * adds one or more freeswitch servers to the cluster.  Any existing servers in the cluster that are not part of the new
 * list will be removed
 * @param {Fsw~createOptions|Array} targets - freeswitch server connection options (or array of same)
 */
Cluster.prototype.addServer = function(targets) {
  assert(typeof targets === 'object' || _.isArray(targets), '\'targets\' must be a single object or array of freeswitch targets') ;

  var self = this ;
  if( !_.isArray(targets) ) {
    targets = [targets] ;
  }

  // get collection of the items to be removed (i.e., they are in current list but not in new list)
  var newIds = _.map( targets, function(t) { return fswId(t); }) ;
  var remove = _.filter( this.pool, function(fsw, id) {
    if( -1 === newIds.indexOf(id) ) { return true ;}
  }) ;

  // add any new servers
  var adds = 0 ;
  targets.forEach( function(t) {
    var id = fswId(t) ;
    if( id in self.pool) {
      console.log('Cluster#addServer: not adding target %s because it already exists', id) ;
      return ;
    }

    adds++ ;
    var fsw = new Fsw(t) ;
    self.pool[id] = fsw ;
    console.log('Cluster#addServer: adding target %s', id) ;
    fsw.connect() ;
    fsw.on('connect', self._onConnect.bind(self, fsw)) ;
    fsw.on('error', self._onError.bind(self, fsw)) ;
  }) ;

  // remove any old servers that do not appear in the new list
  remove.forEach( function(t) {
    var id = fswId(t) ;
    console.log('Cluster#addServer: removing target %s', id) ;
    delete self.pool[id] ;
    t.removeAllListeners('error') ;
    t.disconnect() ;
  }) ;
  console.log('added %d servers and removed %d servers', adds, remove.length) ;
} ;

/**
 * get array of online freeswitch servers
 */
Cluster.prototype.getOnlineServers = function() {
  return _.filter( this.pool, function(fsw) { return fsw.connected() ;}) ;
} ;

Cluster.prototype._onError = function(fsw, err) {
  console.error('freeswitch %s emitted error: ', fswId(fsw), err) ;
  this.emit('offline', fsw.toJSON() ) ;
} ;
Cluster.prototype._onConnect = function(fsw) {
  console.error('freeswitch %s listening on %s:%d connected ok', fswId(fsw), fsw.sipAddress, fsw.sipPort) ;
  this.emit('online', fsw.toJSON() ) ;
} ;
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Sat Nov 28 2015 21:22:30 GMT-0500 (EST) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
